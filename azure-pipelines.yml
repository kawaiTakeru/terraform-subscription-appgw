trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'     # â† Microsoft-hostedï¼ˆAzure Pipelinesï¼‰

variables:
  TF_VERSION: '1.6.6'          # ã”å¸Œæœ›ã©ãŠã‚Š

stages:
  - stage: TerraformApply
    jobs:
      - job: Job
        steps:
          - checkout: self
            displayName: 'ğŸ” Checkout $(Build.Repository.Name)'

          - script: |
              echo "##[group]Step 1: Install Terraform $(TF_VERSION)"
              set -eux
              if ! command -v terraform >/dev/null 2>&1; then
                curl -fsSL "https://releases.hashicorp.com/terraform/$(TF_VERSION)/terraform_$(TF_VERSION)_linux_amd64.zip" -o tf.zip
                unzip -o tf.zip
                sudo mv terraform /usr/local/bin/terraform
                rm -f tf.zip
              fi
              terraform -version
              echo "##[endgroup]"
            displayName: 'âš™ï¸ Install Terraform'

          - script: |
              echo "##[group]Step 2: terraform init"
              set -eux
              cd terraform
              terraform init -input=false
              echo "##[endgroup]"

              echo "##[group]Step 3: terraform plan"
              terraform plan -out=tfplan -input=false
              echo "##[endgroup]"

              echo "##[group]Step 4: terraform apply"
              terraform apply -auto-approve tfplan
              echo "##[endgroup]"

              echo "##[group]Step 5: å®Œäº† âœ…"
              echo "âœ… ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆæˆåŠŸ âœ…"
              echo "##[endgroup]"
            displayName: 'âš™ï¸ Run Terraform'
            env:
              # Entra ã‚¢ãƒ—ãƒªï¼ˆã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ï¼‰ã®è³‡æ ¼æƒ…å ±ã‚’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å¤‰æ•°ï¼ˆSecretï¼‰ã‹ã‚‰æ³¨å…¥
              ARM_CLIENT_ID:       $(ARM_CLIENT_ID)
              ARM_CLIENT_SECRET:   $(ARM_CLIENT_SECRET)
              ARM_TENANT_ID:       $(ARM_TENANT_ID)
              ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
